{"entry_id": "http://arxiv.org/abs/2303.07374v1", "published": "20230313180011", "title": "Higher-Order Methods for Hamiltonian Engineering Pulse Sequence Design", "authors": ["Matthew Tyler", "Hengyun Zhou", "Leigh S. Martin", "Nathaniel Leitao", "Mikhail D. Lukin"], "primary_category": "quant-ph", "categories": ["quant-ph", "cond-mat.dis-nn"], "text": "\n\n\n\nDepartment of Physics, Harvard University, Cambridge, Massachusetts 02138, USA\n\n\nThese authors contributed equally to this work\n\nThese authors contributed equally to this work\n\n\n\nlukin@physics.harvard.edu\n\n\n\n\nWe introduce a framework for designing Hamiltonian engineering pulse sequences that systematically accounts for the effects of higher-order contributions to the Floquet-Magnus expansion.\n\nOur techniques result in simple, intuitive decoupling rules, despite the higher-order contributions naively involving complicated, non-local-in-time commutators.\n\nWe illustrate how these rules can be used to efficiently design improved Hamiltonian engineering pulse sequences for a wide variety of tasks, such as dynamical decoupling, quantum sensing, and quantum simulation.\n\nHigher-Order Methods for Hamiltonian Engineering Pulse Sequence Design\n    Mikhail D. Lukin^1\n    March 30, 2023\n======================================================================\n\n\n\n\n\n\n\n\u00a7 INTRODUCTION AND MOTIVATION\n\nThe effective control of many-body quantum dynamics is an important challenge in the emerging field of quantum science and technology, with wide-ranging applications in quantum computation\u00a0<cit.>, quantum sensing\u00a0<cit.>, and quantum simulation\u00a0<cit.>.\n\nOne of the key tools for controlling such many-body quantum dynamics is Hamiltonian engineering\u00a0<cit.>, in which a train of pulses transform the original system Hamiltonian into a desired target Hamiltonian for various applications.\n\nIndeed, from the inception of such techniques in early NMR work to the present day, Hamiltonian engineering has enabled high resolution spectroscopy\u00a0<cit.>, high sensitivity metrology\u00a0<cit.>, as well as the realization of exotic Floquet phases of matter\u00a0<cit.>.\n\nOne of the key tools for performing Hamiltonian engineering is average Hamiltonian theory\u00a0<cit.>.\n\nHere, the engineered Hamiltonian is approximated by the time-average of interaction-picture Hamiltonians with respect to the control pulses.\n\nThis allows the effective engineering of many-body Hamiltonians, even in the case where only global manipulation of spins is accessible, as is the case in many large-scale quantum systems\u00a0<cit.>.\n\nMoreover, design rules that systematically take into account robustness against various imperfections can be derived\u00a0<cit.>, enabling robust pulse sequence design as well.\n\nDespite the success of techniques based on average Hamiltonian theory, large variations in performance still exist among the different sequences obtained, suggesting that higher-order contributions in the full Magnus expansion may play an important role.\n\nExisting works treating higher-order contributions often rely purely on symmetrization, or treat the higher-order terms on a case-by-case basis\u00a0<cit.>.\n\nHowever, finding general conditions for the cancellation of higher-order Magnus terms can be non-trivial, as the expressions involve commutators that are non-local in time.\n\nIn this paper, we systematically analyze higher-order Magnus contributions to effective Hamiltonians, providing a general toolset for pulse sequence design in interacting spin systems in the form of concise decoupling rules.\n\nDespite the non-local nature of the commutators involved in higher-order contributions, we are still able to generalize many results from average Hamiltonian theory. First, we find that the frame representation employed in Ref.\u00a0<cit.> still provides a convenient way to describe the pulse sequence and contributions, resulting in analytical decoupling rules for higher-order terms.\n\nAs an example, in Fig.\u00a0<ref>(c) we illustrate how first-order Magnus terms involving disorder and Heisenberg interactions have a simple geometric interpretation in analogy with dipoles, and in Fig.\u00a0<ref>(d) we illustrate how first-order Magnus terms involving Ising and Heisenberg interactions have a similar interpretation as balancing the center of mass along a given axis.\nSecond, we find that although there exist additional cross-terms, the majority of finite pulse duration effects can still be described as a simple extension of the effective free evolution time\u00a0<cit.>, making it easy to build in robustness to sequence design.\nFinally, we extend the principle of pulse cycle decoupling\u00a0<cit.> to more general pulse sequences and Hamiltonians, beyond those where the zeroth-order average Hamiltonian vanishes.\n\nWe use this to show how decoupling rules can be significantly simplified for pulse sequences that are composed of common motifs, such as spin echoes\u00a0<cit.> or WAHUHA blocks\u00a0<cit.> (Fig.\u00a0<ref>(a,b)), resulting in time-local decoupling conditions even for higher-order Magnus contributions.\nTogether, these techniques allow us to find higher-order robust pulse sequences with substantially improved performance for a variety of dynamical decoupling, Hamiltonian engineering and quantum sensing applications, as discussed here and in the accompanying paper, Ref.\u00a0<cit.>.\n\nThis paper is organized as follows: in Sec.\u00a0<ref>, we review our representation of the pulse sequence and associated interaction picture Hamiltonian, as well as existing decoupling rules for the zeroth order effective Hamiltonian.\n\nIn Sec.\u00a0<ref>, we utilize this representation to provide general expressions for the higher-order Magnus contributions and present systematic decoupling conditions for higher-order terms.\n\nWe then analyze the structures present in these decoupling rules in Sec.\u00a0<ref>, finding significant simplifications for commonly-found pulse sequence structures in both the disorder-dominant and interaction-dominant regimes.\n\nWe also tabulate the resulting decoupling rules, and provide a pictorial depiction of them.\n\nIn Sec.\u00a0<ref>, we provide further details on the efficient numerical screening of pulse sequences, resulting in high-performance pulse sequences for dynamical decoupling, quantum sensing, and quantum simulation. Finally, in Sec.\u00a0<ref> we conclude with a discussion of further extensions and future directions of the formalism.\n\nA summary of the notation adopted in this manuscript can be found in Appendix.\u00a0<ref>.\n\n\n\n\n\n\n\u00a7 GENERAL FRAMEWORK AND REVIEW OF EXISTING RESULTS\n\n\n\n\n\n \u00a7.\u00a7 General Framework and Frame Representation\n\n\nWe begin by introducing our method to represent the pulse sequence and associated average Hamiltonian, which will greatly simplify the analysis of effective Hamiltonians and finite pulse effects compared to the conventional representation of individual pulses. We will adopt the toggling-frame sequence representation (also known as the Mansfield representation) used in Choi et al.\u00a0<cit.>, which focuses on how operators are transformed under the pulses, rather than the applied pulses themselves. In addition to being a complete and concise representation of the pulse sequence, this representation also has the additional advantage that it leads to simple decoupling conditions that are amenable to fast numerical screening.\n\nConsider a pulse sequence composed of n global spin-rotation pulses {P_1, \u22ef, P_n} acting on a system with native Hamiltonian H, with a free evolution time \u03c4_k preceding the kth pulse P_k. The interaction picture Hamiltonian with respect to the ideal control pulses can then be written as\n\n    H\u0303(t)=U_c^\u2020(t)^\u2297 m H U_c(t)^\u2297 m,\n\nwhere H\u0303(t) is the interaction picture Hamiltonian at time t, U_c(t) is the single spin rotation due to the control field (e.g. U_c(t)=P_kP_k-1\u22ef P_1 right after the kth pulse), and m is the number of spins in the system.\n\nAssuming ideal, infinitely fast rotation pulses, and that the combined rotation unitary is identity P_n\u22ef P_1=I, we can write the total unitary evolution as\n\n    U(T)=\ud835\udcafexp(-\u222b_0^T iH\u0303(t)dt)\u2248exp(-iH^(0)T),\n\nwhere \ud835\udcaf indicates time-ordering and T is the Floquet period. For pulse separations much shorter than the dynamical timescale of the system, we can conveniently write the effective Hamiltonian to leading order as\n\n    H^(0)=1/T\u222b_0^T H\u0303(t_1)dt_1.\n\n\nFor general system Hamiltonians satisfying the secular approximation (rotating wave approximation under a strong quantizing field)\u00a0<cit.>, the interaction picture Hamiltonian H\u0303_s(t) can be uniquely determined by transformations of the S^z operator (we will refer to these as toggling \u201cframes\")\n\n    S\u0303^z(t)=U_c^\u2020(t)S^zU_c(t)=\u2211_\u03bc F_\u03bc(t)S^\u03bc,\n\nwhere S^\u03bc is a basis for the spin system, e.g. the Pauli spin operators for qubits, and we have defined the coefficients\n\n    F_\u03bc(t)=2Tr[S^\u03bcS\u0303^z(t)].\n\n\nAssuming ideal, instantaneous pulses (the case of finite pulse effects and other associated imperfections are discussed in Sec.\u00a0<ref>), we can express the preceding information in the form of a single 4\u00d7 N matrix, where each element F_\u03bc,k corresponds to the coefficient F_\u03bc(t) during the kth free evolution time, and the last row contains the free evolution time duration.\n\nAs a concrete example, let us consider a spin-1/2 system, where each pulse P_k is assumed to be a \u03c0/2 pulse around \u00b1x\u0302,\u0177.\n\nNote that \u03c0 pulses can be viewed as two consecutive \u03c0/2 pulses, with zero time separation in between.\n\nWith S^\u03bc chosen to be the Pauli basis, a spin echo can be represented as\n\n    [ F; \u03c4 ]_echo\n    =[  0  0;  0  0; +1 -1;  \u03c4  \u03c4;    ],\n\nwhile the WAHUHA decoupling sequence for dipolar interactions\u00a0<cit.> can be expressed as\n\n    [ F; \u03c4 ]_WAHUHA\n    =[  0  0 +1 +1  0  0;  0 +1  0  0 +1  0; +1  0  0  0  0 +1;  \u03c4  \u03c4  \u03c4  \u03c4  \u03c4  \u03c4;    ].\n\n\nPictorially, we can represent the first three rows of the matrix by the blocks in Fig.\u00a0<ref>(a,b), in which a yellow(green) block indicates a +1(-1) value along the given axis (row) at a given time (column).\n\nWe illustrate more advanced versions of spin echoes and WAHUHA blocks in Fig.\u00a0<ref>(a,b), in both pulse notation and the frame matrix notation utilized here.\n\nIn the preceding examples, we have neglected finite pulse duration effects, but they can be easily treated by specifying an additional intermediate toggling frame with zero time duration.\n\nThis representation allows us to easily express the interaction picture Hamiltonian H\u0303(t). For example, for a spin-1/2 dipolar-interacting many-body spin system with on-site disorder, the system Hamiltonian can be written as\n\n    H_dip   =\u2211_i h_iS_i^z+\u2211_ijJ_ij(S_i^xS_j^x+S_i^yS_j^y-2S_i^zS_j^z)\n       =\u2211_i h_iS_i^z+\u2211_ijJ_ij(S\u20d7_i\u00b7S\u20d7_j-3S_i^zS_j^z),\n\nwhere h_i is the on-site disorder strength for spin i, and J_ij is the dipolar interaction between spins i and j.\n\nWith our representation, for sequences composed of \u03c0/2 or \u03c0 pulses around \u00b1x\u0302,\u0177, the interaction picture Hamiltonian during the kth free evolution time can be easily expressed as\n\n    H\u0303_dip,k   =\u2211_i\u03bc F_\u03bc,k h_i S_i^\u03bc+\u2211_ijJ_ijS\u20d7_i\u00b7S\u20d7_j-3\u2211_ij\u03bcF_\u03bc,k^2 J_ijS_i^\u03bc S_j^\u03bc,\n\nwhere we have organized the terms according to how they transform with F_\u03bc,k. Using these expressions, it is easy to verify that the spin echo cancels disorder, since \u2211_k F_\u03bc,k\u03c4_k=0, while the WAHUHA pulse sequence fully symmetrizes (decouples) dipolar interactions, since \u2211_k F_\u03bc,k^2\u03c4_k is the same for all \u03bc.\n\nMotivated by these considerations, for any secular Hamiltonian, we will organize the interaction picture Hamiltonian in terms of how the operators transform as the toggling frame changes.\n\nLet us write\n\n    H\u0303(t)=\u2211_\u03b1 c_\u03b1(t)\ud835\udcaa^\u03b1,\n\nwhere c_\u03b1(t) are time-dependent coefficients encoding the frame transformations of a general operator basis set \ud835\udcaa^\u03b1 (we will use greek letters to denote labels of operator sets in the remainder of the paper). For the example above in Eq.\u00a0(<ref>), we can write out the individual terms in the summation as\n\n    \ud835\udcaa^0   =\u2211_ijJ_ijS\u20d7_i\u00b7S\u20d7_j,    c_0(t)   =1,\n    \ud835\udcaa^1,\u03bc   =\u2211_i  h_i S_i^\u03bc,    c_1,\u03bc(t)   =F_\u03bc,k,\n    \ud835\udcaa^2,\u03bc   =3\u2211_ij J_ijS_i^\u03bc S_j^\u03bc,    c_2,\u03bc(t)   =F_\u03bc,k^2,\n\nwhich clearly illustrates how the various terms in the Hamiltonian transform differently with the toggling frames.\n\n\n\n \u00a7.\u00a7 Magnus Expansion\n\nWith this general representation framework in hand, we will now briefly review the Magnus expansion, which provides a useful tool to calculate the effective dynamics of the periodically-driven system, and extend the analysis beyond the average Hamiltonian described in Eq.\u00a0(<ref>).\n\nThe total unitary over a single Floquet cycle can be expressed in terms of a time-independent effective Hamiltonian \ud835\udcb0(T)=exp(-iH_effT), where in the fast-driving limit, the effective Hamiltonian can be written via the Magnus expansion up to order l as H_eff\u2248\u2211_k=0^lH^(k), with\n\n    H^(0)   =1/T\u222b_0^TH(t_1)dt_1,\n    \n        H^(1)   =-i/2T\u222b_0^Tdt_1\u222b_0^t_1dt_2[H(t_1),H(t_2)],\n    \n        H^(2)   =1/6T\u222b_0^Tdt_1\u222b_0^t_1dt_2\u222b_0^t_2dt_3\n       ([H(t_1),[H(t_2),H(t_3)]]+[H(t_3),[H(t_2),H(t_1)]]).\n\n\nHigher-order terms are more complex, involving progressively deeper nested commutators, but in the fast-driving limit they will be relatively suppressed, and we can focus on the leading order terms above.\n\nPlugging in Eq.\u00a0(<ref>) and separating the time-independent operator commutation relation information from the time integrals, we have\n\n    H^(0)   =\u2211_\u03b11/T^\u03b1\u222b_0^T dt_1c_\u03b1 (t_1),\n     H^(1)\n           =\u2211_\u03b1,\u03b2-i/2T[^\u03b1 ,^\u03b2 ]\u222b_0^Tdt_1\u222b_0^t_1dt_2c_\u03b1 (t_1)c_\u03b2 (t_2),\n     H^(2)   =\u2211_\u03b1,\u03b2,\u03b31/6T[^\u03b1,[^\u03b2,^\u03b3]]\u222d_0\u2264 t_3\u2264 t_2\u2264 t_1\u2264 Tdt_1dt_2dt_3\n       (c_\u03b1(t_1)c_\u03b2(t_2)c_\u03b3(t_3)+c_\u03b1(t_3)c_\u03b2(t_2)c_\u03b3(t_1)).\n\nThis allows us to reduce the computation of the Magnus expansion to the evaluation of a few integrals on the c(t) coefficients, which can in turn be readily phrased as algebraic conditions on the set of frame transformations.\n\n\n\n \u00a7.\u00a7 Review of Zeroth Order Rules\n\nUsing the preceding framework, we can readily write down conditions for the cancellation or symmetrization of various zeroth order average Hamiltonian terms, see also Ref.\u00a0<cit.> for details.\n\nFor example, plugging Eqs.\u00a0(<ref>-<ref>) into Eq.\u00a0(<ref>), and assuming ideal, instantaneous pulses, we can easily see that on-site disorder is cancelled when \u2211_k F_\u03bc,k\u03c4_k=0 for each axis \u03bc=x\u0302,\u0177,\u1e91, while interactions are symmetrized into a Heisenberg Hamiltonian or cancelled when \u2211_k F_\u03bc,k^2\u03c4_k is equal for all different \u03bc.\n\nMore importantly, as shown in Ref.\u00a0<cit.>, these conditions can be readily generalized to the case with pulse imperfections.\n\nThe primary effect of finite pulse durations is to extend the effective free evolution times in each frame, as most of the terms generated by \u03c0/2 rotations can be written as an average of the Hamiltonian before and after the pulse.\n\nHowever, there will be additional terms arising from rotation angle errors or interaction cross-terms during rotations, which give rise to additional chirality or parity conditions between neighboring frames\u00a0<cit.>.\n\nThe simple, time-local nature (all rules only involve neighboring frames) of these decoupling conditions enabled efficient design and screening of pulse sequences.\n\nIndeed, using these simple decoupling conditions, novel pulse sequences with improved decoupling performance have been found, leading to the demonstration of the first solid-state AC magnetometer that operates beyond the limits of spin-spin interactions\u00a0<cit.>.\n\nHowever, the further extension of such techniques to incorporate higher-order Magnus contributions and improve performance is at first sight challenging, given the time-non-local nature of higher-order Magnus terms, which involve commutators between all times of a Floquet cycle.\n\nIn the following, we demonstrate how this challenge can be systematically overcome by utilizing the structure of commonly-used pulse sequences.\n\n\n\n\u00a7 SYSTEMATIC ANALYSIS OF HIGHER-ORDER MAGNUS TERMS\n\n\n\nWith the basic formalism in hand, we now turn to the systematic extension of these decoupling rules from zeroth-order to higher-order.\n\nFirst, we will describe the pulse cycle decoupling principle\u00a0<cit.> and extend it to the case of more general interactions, which serves as a useful tool to decompose non-local higher-order terms into local blocks.\n\nWe will then systematically derive expressions for first- and second-order Magnus contributions in the general case, assuming ideal pulses.\n\nFinally, we briefly describe how the treatment can be readily generalized to the case with finite pulse durations, primarily by extending the effective duration of free evolution times, with more details given in Appendix.\u00a0<ref>.\n\n\n\n \u00a7.\u00a7 Pulse Cycle Decoupling\n\n\nIn order to simplify sequence analysis, it is helpful to be able to break down larger pulse sequences into smaller blocks and analyze them independently.\n\nIn this section, we show how common motifs used in sequence design\u2014in the form of spin echoes or interaction symmetrization\u2014allow us to decompose higher-order contributions into a sum of independent, local pieces, no longer requiring non-local correlators between arbitrary locations and thus significantly simplifying the design.\n\nOur results are applicable even to some cases where the symmetrization results in a residual Heisenberg interaction Hamiltonian, thus extending the existing methods\u00a0<cit.> of pulse cycle decoupling to new and experimentally important regimes.\n\nLet us proceed by examining the first-order contribution when sequentially applying two sequences A and B of equal length T.\n\nWe can split the first-order Magnus contribution in Eq.\u00a0(<ref>) into integrals within the first and second sequence respectively, and cross terms between the two sequences, resulting in\n\n    H^(1)=1/2H^(1)_A+(-i/4T)[TH^(0)_B,TH^(0)_A]+1/2H^(1)_B,\n\nwhere H^(0,1)_A,B are the zeroth (first) order effective Hamiltonians during pulse sequences A and B.\n\nThe key observation of pulse cycle decoupling is that if the commutator [H^(0)_A, H^(0)_B] vanishes, then the first-order contribution fully decouples into the sum of that in each individual block, regardless of the details.\n\nIn prior work\u00a0<cit.>, this was achieved by making one of the average Hamiltonians vanish, thus causing the commutator to automatically vanish as well.\n\nFor more general Hamiltonians, however, this no longer directly applies, since the Heisenberg interaction is invariant under global rotations and cannot be cancelled with a global drive\u00a0<cit.>.\n\nDespite this challenge, we find that we can still make use of the pulse cycle decoupling principle in many scenarios beyond the case where the Hamiltonian vanishes.\n\nFirst, even if the total Hamiltonian does not vanish, pulse cycle decoupling can still apply to individual terms.\n\nFor example, if a given block fully decouples disorder (the rapid echo blocks in Fig.\u00a0<ref>(a)), then any first-order terms involving disorder will not have cross terms between this block and other parts of the sequence, simplifying the design.\n\nSecond, if the interaction is transformed into the same form in two separate blocks, then although H_A,B^(0) are both nonzero, they still commute, and so the pulse cycle decoupling principle still applies (see e.g. Fig.\u00a0<ref>).\n\nThus, even if the interaction has a Heisenberg component that cannot be cancelled, the cross-term is still zero because [\u2211_ijJ_ijS_i\u00b7 S_j, \u2211_ijJ_ijS_i\u00b7 S_j]=0.\n\nThis insight generalizes the pulse cycle decoupling principle to cases in which one desires to engineer a non-zero target Hamiltonian, significantly expanding its applicability.\n\n\n\nWhile we have illustrated the pulse cycle decoupling principle at first order, the same methods also apply at higher-order by generalizing the arguments in Ref.\u00a0<cit.>.\n\nFor example, the second-order Magnus contribution can be expressed as a sum of commutators between zeroth and first-order terms, and thus if lower orders are fully symmetrized, then the second-order Magnus contribution will also separate into independent, local blocks.\n\n\n\n \u00a7.\u00a7 First-Order Decoupling\n\n\nWe now return to analyze the structure of higher-order Magnus terms directly and derive decoupling rules for various contributions.\n\nThe expressions here will be derived in full generality, without making use of the pulse cycle decoupling principle, although we will use this to further simplify the expressions in following sections.\n\nIn order to better understand the structure of the first-order Magnus contributions and derive decoupling rules, let us rewrite the preceding expressions into a form that relates them to zeroth-order Magnus contributions and makes clear how terms can be cancelled.\n\nDenoting the zeroth order contribution up to a given time as _\u03b1(t)\u2261\u222b_0^tc_\u03b1 (t_1)dt_1, we can rewrite Eq.\u00a0(<ref>) as\n\n    H^(1)   =-i/T\u2211_\u03b1>\u03b2[^\u03b1 ,^\u03b2 ]\n       \u00d7\u222b_0^Tc_\u03b1 (t_1)_\u03b2(t_1)dt_1-1/2_\u03b1(T)_\u03b2(T).\n\n\nFocusing first on the case of instantaneous, ideal pulses (the more general case will be treated in Sec.\u00a0<ref>), our toggling-frame Hamiltonian becomes piecewise-constant in time, allowing us to replace integrals with summations.\n\nWe can then define the discrete frame equivalents of the terms in the previous section, letting c_\u03b1,k=c_\u03b1 (t) for t\u2208[t_k-\u03c4_k/2,t_k+\u03c4_k/2] and _\u03b1,k\u2261\u2211_l<kc_\u03b1,l\u03c4_l, and find\n\n    H^(1)   =\u2211_\u03b2<\u03b1[^\u03b1 ,^\u03b2 ]\n       \u00d7(\u2211_k=1^n c_\u03b1,k\u03c4_k(_\u03b2, k+1/2\u03c4_k c_\u03b2,k)-1/2_\u03b1,n+1_\u03b2,n+1),\n\nThe first term in the parenthesis can be interpreted as a product between the c_\u03b1 coefficient during a given frame and the integral of zeroth order average Hamiltonians up to the center of the frame.\n\nThe last term is simply the product of two zeroth-order contributions over the entire Floquet period, which will vanish when zeroth-order decoupling rules are satisfied.\n\nGeometrically, this expression can be understood as rewriting the triangular integration area in Eq.\u00a0(<ref>) into a sum over thin column slices.\n\nWe emphasize that these results apply to all first-order contributions, illustrating the common structure found in the decoupling of many different types of terms.\n\nBy keeping track of the running sum, the evaluation of this expression now requires only linear time, as opposed to the naive quadratic complexity.\n\nIn addition, although Eq.\u00a0(<ref>) still contains products of coefficients that are non-local in time, in Sec.\u00a0<ref> we shall see that in many cases of interest, it can be reduced into simple, local decoupling rules.\n\nWe also generalize these results to the case with finite pulse durations in Sec.\u00a0<ref>.\n\nThe primary effect, similar to the zeroth-order case\u00a0<cit.>, is to lengthen the effective duration of each free evolution time by an amount proportional to the pulse duration.\n\nThere will be additional cross terms that we tabulate in the appendix, but they are generally smaller.\n\n\n\n \u00a7.\u00a7 Second-Order Decoupling\n\n\nWe can now apply the same formalism to the second-order Magnus contributions.\n\nAs we show in Appendix.\u00a0<ref>, by reordering the integrals, we can re-express the second-order contribution in terms of the zeroth- and first-order contributions at different times. Let us define the first-order contribution from time t_1 to t_2 of the operator [^\u03b2,^\u03b3] as\n\n\n    c^(1)_\u03b2, \u03b3(t_1,t_2)\n       =\u222c\n    t_1<t_b<t_a<t_2(c_\u03b2(t_a)c_\u03b3(t_b)-c_\u03b2(t_b)c_\u03b3(t_a)),\n\nwhere we have dropped the integrand dt_a dt_b for notational simplicity here and below.\n\nWe can rewrite the expression as follows\n\n    H^(2)   =1/6T\u2211_\u03b1<\u03b2<\u03b3 ([^\u03b1,[^\u03b2,^\u03b3]])\n    \u00d7   \u222b_0^Tdt_1c_\u03b1(t_1)(c^(1)_\u03b2,\u03b3(0,t_1)-c^(1)_\u03b2,\u03b3(t_1,T) ).\n\n\nThus, we see a very similar structure as at first order, wherein the second-order term can also be expressed as a simple integral of lower-order products, enabling formulation of simple decoupling rules.\n\n\n\n \u00a7.\u00a7 Robustness Conditions\n\n\nWe now extend these results to the case with finite pulse durations, and describe how to incorporate robustness to these effects into the sequence design.\n\nWe will focus our attention on the dominant contribution, which we find to be a simple extension of the effective free evolution time by an amount proportional to the pulse duration.\n\nA full treatment of the finite pulse effects, including additional sub-leading cross terms, can be found in Appendix.\u00a0<ref>.\n\n\n\nAs shown in Fig.\u00a0<ref>, with a finite pulse duration, the coefficient c_\u03b1(t) of each term of the Hamiltonian will consist of a ramp up (the preceding rotation), free evolution in the frame, a ramp down (the following rotation), as well as some additional cross-terms between the frames.\n\nThe primary effect of finite pulse effects is illustrated in Fig.\u00a0<ref>(b), in which the effective duration of each frame is lengthened by the integral of _\u03b1, k and _\u03b1 , k over time.\n\nThis is a simple extension of the calculation for the zeroth-order case, and scales as O(\u03c4\u03c4_p), where \u03c4 is the free evolution time and \u03c4_p is the pulse duration.\n\nWe incorporate this into the main term in the decoupling rule table, Tab.\u00a0<ref>, as described in more detail in the next section.\n\nIn addition to this dominant term, there are contributions that scale as O(\u03c4_p^2) or higher powers.\n\nFirst, we have to treat the overlap of the frames, which gives rise to the additional term:\n\n    \u222c_0<\u03b8_2<\u03b8_1<\u03c0/2_\u03b1,k(\u03b8_1)_\u03b2,k+1(\u03b8_2)-_\u03b1,k+1(\u03b8_2)_\u03b2,k(\u03b8_1).\n\nThese terms correspond to the overlap of the ramp up of one frame with the ramp down of another. We note that we get a positive effect from the ramp down of one into the ramp up of the other, and a negative effect from the ramp up of one with the ramp down of the other. These are the main finite pulse effects to each of the correction terms, and are shown in column 4 of Tab.\u00a0<ref>. \n\nThe final contribution originates from first-order contributions involving interaction cross-terms q_\u03c1.\n\nMore specifically, during the continuous rotation from an XX Hamiltonian to a YY Hamiltonian, XY-type terms are generated; the q_\u03c1 cross-terms come from first-order cross-terms between these XY-type terms and other terms.\n\nNote that there will be no such cross-terms for the disorder part of our Hamiltonian.\n\nThus, although the magnitude of this term can in principle scale as O(\u03c4_p\u03c4), in practice the coefficients are small for disorder-dominated systems, and we will analyze this in detail instead in Appendix\u00a0<ref>.\n\n\n\n\u00a7 HIGHER-ORDER DECOUPLING RULES\n\n\n\n\n \u00a7.\u00a7 Summary of General Rules\n\n\n\n\n\n\n\n\n\n\nWe now utilize the results from the preceding section to derive concrete decoupling rules for various important higher-order contributions.\n\nPlugging in different Hamiltonian terms into the expressions derived in Sec.\u00a0<ref>,<ref>, we arrive at the decoupling rules in Tab.\u00a0<ref>.\n\nAs higher-order terms originate from commutators between different terms, we label the cancellation rules with all operators involved.\n\nThe table includes two types of contributions: first, there are the main terms that will appear even with ideal, infinitesimally short pulses, together with corrections to their effective duration due to finite pulse durations; second, we include terms that come purely from the finite pulse duration, in the form of the overlapping pulse term derived in Eq.\u00a0(<ref>).\n\nThere is one additional type of term, as mentioned in the preceding section, that involves interaction cross terms q_\u03c1 during continuous rotations.\n\nWe omit them from this table, since they do not appear for disorder terms that are dominant in our experiments, but we discuss them in more detail in Appendix\u00a0<ref>.\n\nNote also that since the Magnus expansion is not invariant with respect to cyclic permutations of the pulse sequence, there are modifications to terms relating to the first and last frames in the complete expression.\n\nHowever, we neglect them from this table, both to simplify notation, as well as due to the fact that after many Floquet cycles we expect the contributions from these boundary terms to be diminished.\n\nWhile the decoupling rules are somewhat more complicated than the zeroth-order rules derived in Ref.\u00a0<cit.>, many of them nonetheless have simple geometric intuitions (Fig.\u00a0<ref>), and can be further simplified for many common scenarios.\n\nMoreover, the decoupling rules can often be satisfied with simple local motifs, further simplifying the pulse sequence design task.\n\nFor example, in many cases, by using the pulse cycle decoupling principle described in Sec.\u00a0<ref>, one can apply the same rules as zeroth-order sequence design, except requiring the cancellation on a much faster timescale.\n\nThese considerations are summarized in the last column of Tab.\u00a0<ref>.\n\nWe will now go through a few representative examples in more detail, and explain how to interpret and simplify the rules.\n\n\n\n \u00a7.\u00a7 Fast Echo Cancellation for Disorder-Related Terms\n\nLet us now focus our attention on first-order rules related to disorder-disorder and disorder-Ising terms.\n\nTo derive the first and second conditions in Tab.\u00a0<ref>, which hold with full generality and no restrictions on the frame matrix, let us examine the structure of the first-order Magnus contribution shown in Eq.\u00a0(<ref>).\n\nThere, we found that a generic first-order Magnus contribution can be rewritten as a product between the current frame contribution of one term and the cumulative contribution of another term, together with a factor corresponding to the total zeroth order contribution of both terms.\n\nPlugging the disorder and Ising expressions in Eqs.\u00a0(<ref>-<ref>) into Eq.\u00a0(<ref>) results in the rules in the third column of Tab.\u00a0<ref>.\n\nDue to this common structure, we see in Tab.\u00a0<ref> that the decoupling of first-order disorder-disorder and disorder-Ising contributions are almost identical, except replacing one term from scaling with F_\u03bc,k to be scaling instead as F_\u03bc,k^2=|F_\u03bc,k| for F_\u03bc,k=0,\u00b1 1.\n\nWe can thus decouple the primary contribution of both of these first-order effects with the same pulse sequence block, simply by arranging the frames to form fast spin echoes.\n\nThese fast spin echoes are illustrated in Fig.\u00a0<ref>(a).\n\nTo see this, first note that the commutator pre-factor implies that there will be a nonzero contribution only when \u03bc\u2260\u03bd.\n\nWith a spin echo block, the contribution from F_\u03bc,k flips and cancels, while the sum F_<k^\u03bd or I_<k^\u03bd is along a different axis and thus remains unchanged during this time.\n\nMoreover, the average zeroth order disorder Hamiltonian over the entire pulse sequence will also vanish due to the spin echo blocks.\n\nThus, the main term rules in conditions 1 and 2 are satisfied in Tab.\u00a0<ref>.\n\nIn column 4 of Tab.\u00a0<ref>, we derived additional corrections to the expressions, originating from the pulse-induced overlaps in Eq.\u00a0(<ref>).\n\nInterestingly, we find again that the different terms share some common structures, where they can be related to each other simply by replacing F_\u03bd,k by |F_\u03bd,k|.\n\nMoreover, we find that the finite pulse duration corrections for first-order disorder-disorder terms are proportional to that of rotation angle errors at zeroth-order\u00a0<cit.>, making it automatically satisfied if the latter has been incorporated into sequence design.\n\nWe also include an example of a second-order rule involving disorder only in Tab.\u00a0<ref>.\n\nAs one can see, the structure bears many similarities with the first-order contributions.\n\nIn the case where the pulse sequence is composed of fast echoes, we can further simplify the expressions.\n\n\n\n \u00a7.\u00a7 Block Symmetrization for Ising-Ising Terms\n\nMoving on to the first-order Ising-Ising terms (row 3 of Tab.\u00a0<ref>), we see that the structure of the expression again has many similarities as above.\n\nHowever, here we have grouped the terms slightly differently, since the zeroth-order sum I\u0305^\u03bd=\u2211_k |F_k^\u03bd|(\u03c4_k+\u03c4_p) will always be nonzero.\n\nExpressed in this way, first-order Ising-Ising interactions are decoupled by ensuring that for every pair of axes \u03bc and \u03bd, the cumulative occurrences of \u03bd frames before and after each \u03bc frame are equal, i.e. the appearance of the two frames is balanced.\n\nBased on this result, we find that a simple motif is to perform a mirror symmetrization\u00a0<cit.> of the frames within each block, as illustrated in Fig.\u00a0<ref>(b).\n\nNote that since the coefficient of the Ising contribution is identical regardless of the sign of the frame, only the relative frame ordering matters and not the sign.\n\nIf within each block the frames are balanced along the x\u0302, \u0177 and \u1e91 directions, and mirror symmetrization in terms of ordering is performed, then using the pulse cycle decoupling principle, the first-order Ising-Ising contribution will be cancelled.\n\nHere, contrary to global mirror symmetrization, we find that symmetrization within local blocks can also be a useful tool to effectively cancel certain first-order contributions.\n\nThe finite pulse duration correction terms for the first-order Ising-Ising contribution are shown in the fourth column of the Tab.\u00a0<ref>.\n\nThey resemble the other correction terms, but with additional absolute value signs, and can be easily incorporated as decoupling rules in a similar fashion.\n \n\n\n \u00a7.\u00a7 Dipole Cancellation and Row Balancing for Heisenberg-Related Terms\n\nLet us now examine terms related to the Heisenberg interaction S\u20d7\u00b7S\u20d7.\n\nAs noted in Eq.\u00a0(<ref>), the Heisenberg interaction is invariant under frame transformations.\n\nThus, the first-order expression resulting from the Heisenberg term and a different term will be the commutator between a constant term (Heisenberg), and a term that depends on the frame transformations (other).\n\nThe inclusion of the time integrals then result in the expressions in row 4-6 of Tab.\u00a0<ref>, where there are no first-order contributions between two Heisenberg Hamiltonians because they are identical and thus commute.\n\nIn this case, because the Heisenberg Hamiltonian is invariant, the frame length extension becomes exact, and we do not need to include any additional finite pulse corrections in the table.\n\nTo explore in more detail what the resulting rules mean, let us first recall the expressions for cancelling disorder at zeroth order.\n\nHere, we found that in order for disorder to be cancelled at zeroth order, we require the average disorder along each axis to vanish, i.e.\n\n    \u2211_k=1^n F_\u03bc,k(\u03c4_k+4/\u03c0\u03c4_p)=0.\n\n\nA useful physical analogy to interpret this expression is to associate a positive(negative) charge with F_\u03bc,a=+1(-1).\n\nThe zeroth-order decoupling condition then dictates that the average charge is 0.\n\nGeneralizing the analogy to first-order terms, the first-order term of a given Hamiltonian contribution with the invariant Heisenberg Hamiltonian will be proportional to the given Hamiltonian, weighted by its location in time in the sequence.\n\nThis is because of the integration limits in Eq.\u00a0(<ref>), where the relative ordering of the time variable values of the two Hamiltonians determines the sign of the expression.\n\nFurthering the electromagnetic analogy, this results in a distance weighting factor from the center of the pulse sequence timing.\n\nThus, the first-order expression resembles the expression of a dipole, with charge given by F_\u03bc,k at each time point and distance being the distance in time to the center of the sequence.\n\nCancelling this contribution requires the net dipole along each axis to vanish, as illustrated in Fig.\u00a0<ref>(c).\n\nWe note that this intuition was key to improving decoupling pulse sequence performance in Sec.\u00a0<ref>, and led to insights regarding the dichotomy between AC field sensing and decoupling for existing pulse sequences described in Ref.\u00a0<cit.>.\n\nSimilarly, we can also analyze the expression for cross-terms between Ising interactions and Heisenberg interactions, simply by replacing the general charge by a non-negative charge value (|F_\u03bc,k|).\n\nWith only positive charges, the condition can also be alternatively viewed geometrically as balancing frame weights in each row;\n\nas illustrated in Fig.\u00a0<ref>(d), one can imagine a fulcrum placed at the middle of a sequence, and for a given axis, placing a weight whenever the frame is along this axis (regardless of it being a positive or negative frame); the rule then becomes that the row would balance.\n\n\n\n\u00a7 DETAILED SEQUENCE DESIGN PROCEDURE\n\n\n\nWe now utilize the preceding insights to design higher-order pulse sequences for various applications, focusing on the case of interacting spin ensembles dominated by on-site disorder\u00a0<cit.>.\n\nThe result is a pulse sequence that decouples all zeroth-order and first-order contributions in the Magnus expansion, and is robust against disorder to second order, which we name DROID-R2D2 (Disorder RObust Interaction Decoupling - Robust To Disorder 2nd order), and a pulse sequence that achieves similar results but also has interesting AC field sensing capabilities\u00a0<cit.>.\n\nThese pulse sequences were crucial for a variety of our recent experiments in dynamical decoupling, quantum metrology\u00a0<cit.>, and Hamiltonian engineering\u00a0<cit.>.\n\nWe will illustrate the complete design procedure in detail, and mention a few practical tricks to improve the efficiency of sequence screening and to examine larger design spaces of pulse sequences.\n\n\n    \n  1. Choose target decoupling rules\n\n\nThe first step is to determine the set of decoupling rules that should be satisfied by the desired sequence.\n\nThe choice of this set is usually informed by several factors: First, the target application may influence which terms need to be decoupled.\n\nFor example, if we wish to study many-body dynamics in a disordered system, we may wish to preserve the disorder term while engineering interactions.\n\nAlternatively, if we are interested in quantum sensing, then there may be additional design rules that are imposed to maximize sensitivity.\n\n\n\n\n\nSecond, the experimental system characteristics may inform which contributions are most important to decouple.\n\nAs an example, dense electronic spin ensembles, such as nitrogen-vacancy (NV) centers and nitrogen (P1) defects in diamond, or rare earth ions, typically have much larger disorder than interactions\u00a0<cit.>.\n\nThus, it is much more important to address disorder-related effects to higher-order than interaction-related effects.\n\nThe relative importance of different contributions can be made more quantitative by using our expressions for various terms to estimate the typical total magnitude of each of the Hamiltonian terms.\n\nFinally, for a given pulse sequence, we can also diagnose the dominant residual term by examining a cluster of a few spins, typically two or three, and computing the exact unitary for a set of disorder and interaction values.\n\nTaking the matrix log of the unitary yields the exact effective Hamiltonian, and performing polynomial fits of the dominant terms with respect to the disorder and interaction strengths informs us which type of contribution is the largest, as well as the order at which it contributes in the Magnus expansion.\n\nFor example, in Fig.\u00a0<ref>(a), we find that the dominant error terms for the existing DROID sequence from Ref.\u00a0<cit.> are the XZ and ZX components of the Hamiltonians, when decomposed in the Pauli basis.\n\nIn Fig.\u00a0<ref>(a,b), we find that the dominant scaling of this term is linear in both the disorder strength and interaction strength, suggesting that it originates from a first-order cross-term between them.\n\nThis motivated us to systematically include decoupling rules that target this effect.\n\nIn practice, we search for sequences by randomly enumerating those of a fixed length that satisfy a chosen set of rules (see below for a description of how to efficiently enforce rules).\n\nWe iterate the preceding error diagnosis step several times by identifying the dominant contributions for typical pulse sequences, and adding in new rules to fully decouple them.\n\nEach addition of a new dominant rule eliminates the most poorly performing sequences, and increases the probability of enumerating a sequence with high coherence time; see Fig.\u00a02 of the accompanying paper\u00a0<cit.>.\n\nFollowing this procedure leads us to include the following decoupling rules for our disorder-dominated NV center ensemble: decoupling of all zeroth-order conditions, as described in Ref.\u00a0<cit.>; decoupling of all first-order conditions involving at least one factor of disorder, including disorder-disorder cross-terms, disorder-Ising and disorder-Heisenberg cross-terms, for both free evolution times and pulses; second-order disorder-disorder-disorder cross-terms, for both free evolution times and pulses.\n\n\n    \n  2. Efficiently construct candidate frame sets\n\n\nWith the set of target decoupling rules in hand, we now discuss how to efficiently enumerate pulse sequences satisfying a set of imposed decoupling rules.\n\nThe number of possible frame sets without any additional constraints is combinatorially large.\n\nFor example, even a sequence consisting of 12 free evolution times connected by \u03c0/2 pulses, including intermediate frames for the finite pulse durations (e.g. the frame half way through \u03c0 pulses or composite \u03c0/2 pulses), admits approximately 4^23\u2248 10^14 distinct pulse sequences (each frame is connected to 4 other frames by \u03c0/2 pulses, and the first frame is fixed to be +\u1e91).\n\nHowever the vast majority of these sequences will not satisfy our rules. \n\nTherefore it is essential to enumerate only sequences that satisfy them.\n\nFor the disorder-dominated interacting NV ensembles we work with, we choose to impose the following structures to efficiently pre-screen pulse sequences:\n\nwe require that all frames, including both free evolution and pulse frames, come in spin echo pairs, in order to echo out disorder on the fastest possible timescale.\n\nIn addition, we require an equal number of elements along each row, so as to symmetrize interactions.\n\nFinally, we impose the \u201cdipole\" rules for first-order disorder-Heisenberg cross-terms, by requiring there to be an equal number of +- and -+ spin echoes.\n\nIn order to directly restrict the search space to candidate frame sequences that satisfy the above rules, we separately enumerate the locations of X, Y and Z spin echo pairs, and enumerate the echo ordering signs (i.e. whether the echo frames has the ordering +- or -+) of both free evolution frames and finite pulse frames.\n\nWe then combine these pieces of information to generate candidate frame sequences, imposing the additional constraint that each frame must be distinct from the two neighboring frames, to ensure that a \u03c0/2 pulse is applied and the pulse error calculation is accurate.\n\n\n    \n  3. Screen frame sets using decoupling rules\n\n\nHaving generated candidate frame sets that already have a number of rules enforced by construction, we now proceed to screen through them by applying the remaining decoupling rules.\n\nIn order to speed up the screening process, the key insight is to transform the original rules into a vectorized form, such that fast matrix computation can be performed, significantly reducing the run time.\n\nThis is achieved by labeling the frames as 1 to 6 for +x,+y,+z,-x,-y,-z, and noting that the rules become simple cumulative sums of index matching results when expressed in this fashion.\n\nWe then further simplify them based on known decoupling structures (e.g. the rapid spin echoes built into the sequence).\n\nMoreover, when evaluating some of the higher-order expressions in full generality, we can keep track of the cumulative integral of lower-order terms\u00a0<cit.>, which reduces the time complexity of computing many such terms to linear in the sequence length, rather than a higher polynomial scaling.\n\n\n    \n  4. Verify performance and further optimization\n\n\nTo optimize the performance of the pulse sequences, we further symmetrize the pulse sequence to reduce higher-order error contributions.\n\nHere, for dynamical decoupling, we employ the symmetrization used in Ref.\u00a0<cit.>, where the frames are repeated twice, but the frame ordering is reversed and sign of all frames flipped in the second repetition.\n\nFor the quantum metrology pulse sequences designed here and in Ref.\u00a0<cit.>, this symmetrization will affect the magnetic field sensitivity, and consequently we employ a mirror-symmetrization instead, where the frame ordering is reversed but the sign is not flipped in the second repetition.\n\nFinally, we numerically simulate the performance of these pulse sequences to identify the ones with the longest decoupling timescales.\n\nEffective Hamiltonian extraction using the matrix log of the unitary can identify dominant error terms for the pulse sequences employed, and the whole design procedure can be repeated with an improved rule set.\n\nFor the above final set of decoupling rules, we no longer find a single contribution that dominates over the others, instead seeing a competition between several different contributions.\n\n\n\n\n\n \u00a7.\u00a7 Resulting Pulse Sequences\n\n\nUsing the decoupling rules described above, we designed pulse sequences for dynamical interaction decoupling, many-body physics, and quantum metrology.\n\nFor dynamical decoupling and Hamiltonian engineering, one of the best pulse sequences we identified, DROID-R2D2, is shown in Fig.\u00a0<ref>(b).\n\nWe find that compared to the previous best pulse sequence DROID\u00a0<cit.>, as shown in Fig.\u00a0<ref>(a), that had significant residual first-order cross terms (Fig.\u00a0<ref>(a)), primarily cross terms between disorder and first-order Heisenberg interactions, the residual errors when examining the effective Hamiltonian are much reduced (Fig.\u00a0<ref>(b)).\n\nMoreover, we can adapt this pulse sequence to perform Hamiltonian engineering by adjusting the frame durations along the x\u0302, \u0177 and \u1e91 axes\u00a0<cit.>, resulting in a tunable interaction Hamiltonian\n\n\n    H_XXZ=\u2211_ijJ_ij[1+\u03bb/3(S_i^xS_j^x+S_i^yS_j^y)+1-2\u03bb/3S_i^zS_j^z],\n\n\nwhere \u03bb is a coefficient that tunes the XXZ Hamiltonian.\n\nWe find that our techniques also significantly reduce the error in engineering a wide range of generic XXZ Hamiltonians.\n\nIn Fig.\u00a0<ref>(c,d), we see that both two-body and single-body imperfection terms are much smaller across a wide range of different Hamiltonians, which can help improve the fidelity of Hamiltonian engineering and reduce systematic artifacts.\n\nThese techniques can be readily generalized to engineer XYZ Hamiltonians, with different coefficients in front of each term, or even more complex many-body Hamiltonians.\n\nThe same techniques can also be used to design pulse sequences for improved quantum sensing, as we explain in more detail in Ref.\u00a0<cit.>.\n\nThe key insight is that current pulse sequences for quantum sensing\u00a0<cit.>, which periodically flip the spin along each axis with the same frequency as the target signal, will always result in a violation of the \u201cnet dipole cancellation\" rule in Fig.\u00a0<ref>(c) for first-order disorder-Heisenberg terms.\n\nThis imposes a fundamental trade-off between sensitivity and decoupling quality for current pulse sequences.\n\nWith this insight from higher-order decoupling rules, we are able to design the new pulse sequence DIRAC2 (DIsorder Robust AC sensing with period 2), as shown in Fig.\u00a0<ref>(c), which circumvents this issue by targeting a sensing signal half the frequency of frame flipping, thereby fully cancelling all first-order Magnus contributions while also increasing the rate of spin echo decoupling, leading to better performance.\n\nSee Ref.\u00a0<cit.> for a more detailed description.\n\n\n\n\u00a7 DISCUSSION AND CONCLUSION\n\n\nWe have developed a general framework for dynamical Hamiltonian engineering that includes higher-order considerations.\n\nContrary to the naive expectation, we found that many higher-order decoupling conditions can still have simple, intuitive interpretations, particularly when the pulse sequence is designed to have certain structures in it.\n\nWe analytically derived a number of decoupling rules for higher-order contributions, and used them to design robust pulse sequences in disorder-dominated systems for dynamical decoupling, Hamiltonian engineering, and quantum sensing, significantly improving upon state-of-the-art pulse sequences.\n\nWhile we have focused on the application of our techniques to the case of electronic spin ensembles, where disorder is much larger than spin-spin interactions, we believe that our techniques can be applied to disparate systems such as NMR\u00a0<cit.>, simply by changing which rules are emphasized and included at higher-order.\n\nIt may also be interesting to further extend the techniques to even higher-order than the ones that we have considered here\u00a0<cit.>, or to examine alternative expansions beyond the Magnus expansion\u00a0<cit.>.\n\nIn our formalism, the contributions from higher-order terms are decomposed into an operator commutation portion, and a portion that relates to the frame matrix and pre-factors.\n\nThis also makes the extension to higher-spin systems relatively straightforward, and can be combined with recent methods for robust Hamiltonian engineering with higher-spin systems\u00a0<cit.>.\n\nWith these further improvements, we believe that our framework presents a key tool for advanced Hamiltonian engineering pulse sequence design, with broad applications in dynamical decoupling, quantum many-body physics, and quantum metrology.\n\n\n\n\u00a7 ACKNOWLEDGEMENTS\n\nWe thank J.\u00a0Choi, A.\u00a0Douglas, H.\u00a0Gao, N.\u00a0Maskara, P.\u00a0Peng, M.\u00a0Yu for helpful discussions. This work was supported in part by CUA, HQI, NSSEFF, ARO MURI, DARPA DRINQS, Moore Foundation GBMF-4306, NSF PHY-1506284.\n\n\n\n\n\n\u00a7 CONVENTIONS\n\n\nSee Tab.\u00a0<ref> for a summary of the conventions employed in this manuscript.\n\n\n\n\n\u00a7 DERIVATION OF FIRST-ORDER MAGNUS FORMALISM\n\n\n\nTo develop the full expression at first order, we extend the formalism developed in Ref.\u00a0<cit.>. To keep the expressions fully general, we do not restrict to a specific qubit Hamiltonian here, and specialize to the dipolar Hamiltonian only in the following sections.\n\nFollowing Ref.\u00a0<cit.>, we can separate the evolution into free evolution periods and evolution during pulses.\n\nWe will write the coefficient of a given operator ^\u03b1 during the k-th free evolution period as c_\u03b1(t)=c_\u03b1,k, and during the \u03c0/2 pulse after the k-th free evolution period as\n\n    c_\u03b1(t)=_\u03b1,k(t/r)+q_\u03b1,k,k+1(t/r)+_\u03b1,k+1(t/r).\n\nHere, r is the rate of angular precession under the applied pulses, and the rotation angles during the \u03c0/2 pulse are given by \u03b8=t/r.\n\nThe first term _\u03b1,k(\u03b8) describes the finite pulse duration contribution from the k-th frame that precedes the pulse, while _\u03b1,k+1(\u03b8) describes the contribution from the (k+1)-th frame that follows the pulse.\n\nq_\u03b1,k,k+1(\u03b8) is an additional cross-term between the two frames that arises for certain types of interaction terms.\n\nNote that similar to Ref.\u00a0<cit.>, in our pulse sequence composed of \u03c0/2 pulses and \u03c0 pulses, we treat each \u03c0 pulse as a combination of two \u03c0/2 pulses with zero free evolution time in between.\n\nAs a concrete example to illustrate these terms, let us consider a rotation that transformed the S^z operator into S^x, i.e. S\u0303^z(\u03b8)=cos\u03b8 S^z+sin\u03b8 S^x.\n\nFor an Ising interaction H_I=JS_i^zS_j^z, the time-dependent operator would be\n\n    H\u0303_I(t)   =J[cos^2\u03b8 S_i^zS_j^z+sin\u03b8cos\u03b8(S_i^xS_j^z+S_i^zS_j^x)+sin^2\u03b8 S_i^xS_j^x].\n\nThe three terms in the parenthesis correspond to the _\u03b1,k(\u03b8), q_\u03b1,k,k+1(\u03b8) and _\u03b1,k+1(\u03b8) terms, respectively.\n\nWith this representation in hand, we proceed by rewriting the integral in Eq.\u00a0(<ref>) as a summation over the distinct blocks.\n\nLet us examine the first term, which integrates all c_\u03b2 terms occurring temporally before c_\u03b1:\n\n    A=\u222b_0^Tdt_1c_\u03b1(t_1)\u222b_0^t_1dt_2c_\u03b2(t_2)\n\n\nTo compute this, we first define the integral of the coefficient of a given frame, including its finite pulse duration effects:\n\n    C_\u03b1,k=r\u222b_0^\u03c0/2_\u03b1,k(\u03b8)d\u03b8+\u222b_0^\u03c4_kc_\u03b1,kdt+r\u222b_0^\u03c0/2_\u03b1,k(\u03b8)d\u03b8.\n\n\nThis can be viewed as a simple extension of the effective free evolution time.\n\nWe can then decompose the inner integral in Eq.\u00a0(<ref>) into three parts (ignoring additional contributions from q_\u03b1,k,k+1-terms for now): a contribution from previous, non-overlapping free evolution times, together with their surrounding pulses (A_free); a contribution from integrating both time variables within the same free evolution period, corresponding to first-order contributions within the same frame (C_\u03b1,\u03b2,k^(1)); and a further correction arising from the pulse overlaps of neighboring free evolution times (P_k,k+1,\u03b1,\u03b2).\n\nThis is illustrated in Fig.\u00a0<ref>.\n\nMore concretely, the first term describes contributions where t_1 lies within the k-th frame, and t_2 originates from an earlier frame. As most of these contributions will be temporally non-overlapping, we can factorize these contributions as\n\n    A_free=\u2211_k=1^n C_\u03b1,k\u2211_j=1^k-1C_\u03b2,j.\n\n\nThe next term describes contributions where both t_1 and t_2 come from the k-th frame, with t_2<t_1\u2208[t_k-1+\u03c4_k-1/2,t_k+1-\u03c4_k+1/2], i.e. the first-order Magnus contribution of a frame with itself.\n\nWe can explicitly write this as\n\n    C^(1)_\u03b1,\u03b2,k=\u222b_t_k-1+\u03c4_k-1/2^t_k+1-\u03c4_k+1/2c_\u03b1(t_1)dt_1\u222b_t_k-1+\u03c4_k-1/2^t_1c_\u03b2(t_2)dt_2.\n\nNote that this term is usually zero in our case, as the commutator [^\u03b1,^\u03b2] vanishes when \u03b1=\u03b2, and otherwise c_\u03b1, c_\u03b2 are both non-zero within the same free evolution period only when they originate from different types of non-commuting Hamiltonians, e.g. one coming from local S^z disorder, and the other coming from Heisenberg interactions.\n\nFinally, we have additional corrections P_k,k+1,\u03b1,\u03b2 that arise from the overlap in terms due to the pulses: for the k-th frame, we overcounted the overlap contribution with the previous (k-1)-th frame by assuming that the k-th frame came completely after the (k-1)-th frame, but undercounted the overlap contribution with the next (k+1)-th frame.\n\nExplicit calculation shows that this results in a first order pulse correction that is related to both the preceding and subsequent frame:\n\n    P_k,k+1,\u03b1,\u03b2=\u222b_0^\u03c0/2_\u03b1,k(\u03b8_1)rd\u03b8_1\u222b_0^\u03b8_1_\u03b2,k+1(\u03b8_2)rd\u03b8_2-\u222b_0^\u03c0/2_\u03b1,k+1(\u03b8_1)rd\u03b8_1\u222b_\u03b8_1^\u03c0/2_\u03b2,k(\u03b8_2)rd\u03b8_2.\n\n\nThus, neglecting all terms that directly dependent on multiple pulses (see q-terms below), we can express the integral in a clean manner as\n\n    A=A_free+\u2211_k=1^n-1P_k,k+1,\u03b1,\u03b2+\u2211_k=1^nC^(1)_\u03b1,\u03b2,k.\n\n\nFor certain interaction terms such as the Ising Hamiltonian, there is an additional contribution we need to keep track of, the q_\u03b1,k,k+1(\u03b8) terms described in Eq.\u00a0(<ref>).\n\nThese terms come from the fact that the Ising interaction transforms as the square of the frame coefficients, introducing additional cross-terms when expanding the square.\n\nThese terms are ignored in the main text, as they are negligible for our disorder-dominated system, but we will analyze them in more detail here.\n\nWe can perform a similar decomposition of the terms as above, now adding in the contributions from the q-terms.\n\nWe can treat the q-terms as a special type of free evolution frame, and decompose the sum into the three types again, this time keeping track also of whether the other term is a q-term or a regular free evolution period.\n\nSimilar to Eq.\u00a0(<ref>), we can evaluate the first-order contributions involving a single q-term and a single free evolution frame as\n\n    QA_free=\u2211_k=1^nC_\u03b1,k\u2211_j=1^k-1Q_\u03b2,j,j+1+\u2211_k=1^nQ_\u03b1,k,k+1\u2211_j=1^kC_\u03b2,j,\n\nwhere\n\n    Q_\u03b1,k,k+1=\u222b_0^\u03c0/2q_\u03b1,k,k+1(\u03b8)d\u03b8\n\nis the integral of the q-term during a given pulse.\n\nIn analogy to the corrections P_k,k+1,\u03b1,\u03b2 found above, we also have similar corrections here\n\n    QP_k,k+1,\u03b1,\u03b2   =\u222b_0^\u03c0/2q_\u03b1,k,k+1(\u03b8_1)rd\u03b8_1\u222b_0^\u03b8_1_\u03b2,k+1(\u03b8_2)rd\u03b8_2-\u222b_0^\u03c0/2q_\u03b1,k,k+1(\u03b8_1)rd\u03b8_1\u222b_\u03b8_1^\u03c0/2_\u03b2,k(\u03b8_2)rd\u03b8_2\n       +\u222b_0^\u03c0/2_\u03b1,k(\u03b8_1)rd\u03b8_1\u222b_0^\u03b8_1q_\u03b2,k,k+1(\u03b8_2)rd\u03b8_2-\u222b_0^\u03c0/2_\u03b1,k(\u03b8_1)rd\u03b8_1\u222b_\u03b8_1^\u03c0/2q_\u03b2,k-1,k(\u03b8_2)rd\u03b8_2.\n\n\nFinally, we also have corrections coming from the first-order contributions between q-terms at different times and in the same pulse\n\n    Q_self=\u2211_k=1^nQ_\u03b1,k,k+1\u2211_l=1^k-1Q_\u03b2, l,l+1+\u2211_k=1^n\u222b_0^\u03c0/2q_\u03b1,k,k+1(\u03b8_1)rd\u03b8_1\u222b_\u03b8_1^\u03c0/2q_\u03b2,k,k+1(\u03b8_2)rd\u03b8_2.\n\n\nPutting all of this together, the final, complete expression for first-order terms is\n\n    A=A_free+\u2211_k=1^n-1P_k,k+1,\u03b1,\u03b2+\u2211_k=1^nC^(1)_\u03b1,\u03b2,k+QA_free+Q_self+\u2211_k=1^nQP_k,k+1,\u03b1,\u03b2\n\n\n\n\n\u00a7 DERIVATION OF FIRST-ORDER CANCELLATION RULES\n\n\n\n\n\nWe will now apply the preceding general calculations to specific first-order terms, in order to derive first-order decoupling rules.\n\nAs we shall see, in many cases of interest, a lot of the terms in Eq.\u00a0(<ref>) will drop out, resulting in simple expressions.\n\n\n\n \u00a7.\u00a7 Disorder-Disorder Rules\n\nLet us start with first-order disorder-disorder contributions, involving commutators between disorder at different times.\n\nSince this Hamiltonian involves only single-qubit terms, there will be no q-terms.\n\nFurthermore, there are no C^(1)_\u03b1,\u03b2,k terms, as the operator in each frame commutes with itself.\n\nWe thus have\n\n    A_dis-dis=A_free+\u2211_k=1^n-1P_k,k+1,\u03b1,\u03b2.\n\n\nExamining the transformation of the operators for different frames, we have\n\n    c_\u03b1,k   \u2192 F_\u03bc,k,\n    _\u03b1,k(\u03b8)   \u2192 F_\u03bc,ksin(\u03b8),\n    _\u03b1,k(\u03b8)   \u2192 F_\u03bc,kcos(\u03b8),\n    \n    C_\u03b1,k   = F_\u03bc,k(\u03c4_k+4\u03c4_p/\u03c0).\n\n\nPlugging this into the preceding definitions of the individual terms, we find\n\n    A_free   =\u2211_k=1^nF_\u03bc,k(\u03c4_k+4\u03c4_p/\u03c0)\u2211_l=1^k-1F_\u03bd,l(\u03c4_l+4\u03c4_p/\u03c0),\n    \n    P_k,k+1,dis,dis   = (F_\u03bc,kF_\u03bd,k+1-F_\u03bc,k+1F_\u03bd,k)(1-\u03c0/4)(2\u03c4_p/\u03c0)^2,\n\n\nFurther plugging this into the full expression Eq.\u00a0(<ref>) for the first-order disorder-disorder term, we arrive at the full expression for the main term\n\n    \u2211_k=1^nF_\u03bc,k(\u03c4_k+4/\u03c0\u03c4_p)F^\u03bd_<k-1/2F\u0305^\u03bcF\u0305^\u03bd,\n\nand the finite pulse correction\n\n    (1-\u03c0/4)(2\u03c4_p/\u03c0)\u2211_k=1^nF_\u03bc,kF_\u03bd,k+1-F_\u03bd,kF_\u03bc,k+1,\n\nas described in Tab.\u00a0<ref>.\n\nBased on these expressions, we can formulate relatively simple rules for their cancellation in sequence design.\n\nThe expression P_k,k+1,\u03b1,\u03b2 involves a term that can be rewritten as F\u20d7_k\u00d7F\u20d7_k+1, and thus has the same conditions for cancellation as zeroth-order rotation angle errors\u00a0<cit.>.\n\nDue to the rapid spin echo structure found in many decoupling sequences for disorder-dominated systems, e.g. DROID-60 in Ref.\u00a0<cit.>, the majority of terms in A_free are also cancelled in the inner sum, and the only contribution remaining is from the commutator between a spin echo pair and the intermediate pulse frame that the \u03c0 pulse uses.\n\nTo give a concrete example of this remaining contribution, consider a sequence of two \u03c0 pulses around X, which implements the following frame transformations +Z \u2192 +Y \u2192 -Z \u2192 -Y, with +Z and -Z being longer free evolution frames, and +Y and -Y being shorter frames with zero free evolution time and only pulse effects.\n\nThe first-order contribution from this will then be proportional to the commutator between Z and Y, and changes sign both when we flip the sign of one of the operators (e.g. +Z \u2192 -Y \u2192 -Z \u2192 +Y), as well as when we switch the order of the operators (e.g. +Y \u2192 +Z \u2192 -Y \u2192 -Z).\n\nThus, this term has the same transformation properties as a rotation angle error that acts only within such spin echo blocks.\n\n\n\n \u00a7.\u00a7 Disorder-Heisenberg Rules\n\nThe next term we consider is the first-order disorder-Heisenberg contribution, which was the dominant imperfection in the previous DROID-60 sequence\u00a0<cit.> and key to the design of improved sensing sequences such as DIRAC2\u00a0<cit.>.\n\nAs shown in Eq.\u00a0(<ref>), we can choose an index ordering where disorder is after Heisenberg interactions, such that \u03b1 is a disorder index and \u03b2 is a Heisenberg interaction index.\n\nThe case where both are Heisenberg indices gives zero contribution, as the operator terms are equal to the fixed Heisenberg Hamiltonian and hence commute.\n\nAs the Heisenberg interaction is invariant under frame transformations, the coefficients can be chosen to take a particularly simple form:\n\n    c_\u03b2,k   \u2192 1,\n        \n    _\u03b2,k(\u03b8)   \u2192 1,\n        \n    _\u03b2,k(\u03b8)   \u2192 0,\n        \n    \n        C_\u03b2,k   =\u03c4_k+\u03c4_p.\n\nPlugging these into the preceding expressions, we find\n\n    A_free   =\u2211_k=1^nF_\u03bc,k(\u03c4_k+4\u03c4_p/\u03c0)\u2211_j=1^k-1(\u03c4_j+\u03c4_p),\n    \n    P_k,k+1,\u03b1,\u03b2   =F_\u03bc,k(\u03c0/2-1)(2\u03c4_p/\u03c0)^2,\n    \n    C_\u03b1,\u03b2,k^(1)   =F_\u03bc,k[\u222b_0^\u03c0/2sin(\u03b8_1)rd\u03b8_1\u222b_0^\u03b8_1rd\u03b8_2+\u222b_0^\u03c4_kdt_1(\u03c4_p+\u222b_0^t_1dt_2)+\u222b_0^\u03c0/2cos(\u03b8)rd\u03b8(\u03c4_p+\u03c4_k)]\n       =F_\u03bc,k[(2\u03c4_p/\u03c0)^2+\u03c4_k\u03c4_p+\u03c4_k^2/2+(\u03c4_p+\u03c4_k)(2\u03c4_p/\u03c0)].\n\n\nWe can simplify the sum of the last two contributions\n\n    P_k,k+1,\u03b1,\u03b2+C^(1)_\u03b1,\u03b2,k   =F_\u03bc,k(\u03c4_k\u03c4_p+1/2\u03c4_k^2+(2\u03c4_p+\u03c4_k)(2\u03c4_p/\u03c0))\n       =F_\u03bc,k(\u03c4_p+1/2\u03c4_k)(\u03c4_k+4\u03c4_p/\u03c0).\n\n\nAdding the corrections together, we get\n\n    A=\u2211_k=1^nF_\u03bc,k(\u03c4_k+4\u03c4_p/\u03c0)\u2211_j=1^k-1(\u03c4_j+\u03c4_p+\u03c4_p+1/2\u03c4_k)=\u2211_k=1^nF_\u03bc,kt_k(\u03c4_k+4\u03c4_p/\u03c0),\n\nwhere t_k is the midpoint of the kth free evolution frame.\n\nThe remaining term in Eq.\u00a0(<ref>) can be evaluated to be\n\n    1/2_\u03b1(T)_\u03b2(T)=F\u0305^\u03bcT/2,\n\nwhich combined give us the full algebraic condition for first-order disorder-Heisenberg decoupling\n\n    \u2211_k=1^nF_\u03bc,k(\u03c4_k+4/\u03c0\u03c4_p)(t_k-T/2).\n\n\nAs described in the main text and in Ref.\u00a0<cit.>, there is a relatively simple intuition for these contributions, which we visualize using dipole balancing.\n\nIf we associate a charge to each frame, with +1(-1) values of F_\u03bc,k being a positive(negative) charge, then the above expression corresponds to the product of charges (F_\u03bc,k) with their center-of-mass location (t_k-T/2), which is precisely the definition of a dipole.\n\nThus, geometrically, we can visualize the cancellation of first-order disorder-Heisenberg contributions as requiring that the net dipole corresponding to a frame configuration to be 0.\n\n\n\n \u00a7.\u00a7 Disorder-Ising Rules\n\nNext we move on to the Ising contributions, starting with first-order disorder-Ising terms.\n\nFor this, we use c_\u03b1,k from the disorder term, and we use the following for the c_\u03b2,k terms:\n\n    c_\u03b2,k   \u2192 |F_\u03bd,k|, \n    \n    _\u03b2,k(\u03b8)   \u2192 |F_\u03bd,k|sin^2(\u03b8),\n    \n    _\u03b2,k(\u03b8)   \u2192 |F_\u03bd,k|cos^2(\u03b8),\n    \n    \n    q_\u03b2,k,k+1(\u03b8)   \u2192 F_\u03bd,kF_\u03c1,k+1sin(\u03b8)cos(\u03b8),\n    \n    \n    C_\u03b2,k   =|F_\u03bd,k|(\u03c4_k+\u03c4_p),\n    \n    \n    Q_\u03b2,k,k+1   =F_\u03bd,kF_\u03c1,k+1\u03c4_p/\u03c0.\n\n\nPlugging these into the definitions for the individual terms, we find\n\n\n    A_free   =\u2211_k=1^nF_\u03bc,k(\u03c4_k+4\u03c4_p/\u03c0)\u2211_l=1^k-1|F_\u03bd,l|(\u03c4_l+\u03c4_p),\n    \n    \n    P_k,k+1,dis,isi   =(F_\u03bc,k|F_\u03bd,k+1|-F_\u03bc,k+1|F_\u03bd,k|)(\u03c0/4-2/3)(2\u03c4_p/\u03c0)^2.\n\n\nThe term C^(1)_\u03b1,\u03b2,k will not contribute, as the disorder and Ising Hamiltonian within the same free evolution time commute with each other, [S^\u03bc\u2297 I, S^\u03bc\u2297 S^\u03bc]=0.\n\nThe algebraic conditions in the Tab.\u00a0<ref> are based on the preceding expressions, and ignore the q-terms.\n\nCombining A_free with the rest of the terms gives the main term:\n\n    \u2211_k=1^nF_\u03bc,k(\u03c4_k+4/\u03c0\u03c4_p)I_<k^\u03bd-1/2F\u0305^\u03bcI\u0305^\u03bd.\n\nSumming over pulses in the pulse term gives the finite pulse correction\n\n    \u2211_k=1^n(2\u03c4_p/\u03c0)^2(\u03c0/4-2/3)(F_\u03bc,k|F_\u03bd,k+1|-|F_\u03bd,k|F_\u03bc,k+1).\n\nThe main term will vanish with the same fast spin echo blocks as that found in the first-order disorder-disorder term, and the finite pulse correction can be viewed as a simple generalization of, e.g. the chirality condition in Ref.\u00a0<cit.>.\n\nWe now further evaluate the q-terms.\n\nAs any two adjacent frames will have different operators due to the frame change, we will have no contribution when \u03bd=\u03c1. Explicitly plugging into the above expressions gives\n\n    QA_free   =\u2211_k=1^nF_\u03b1,k(\u03c4_k+4/\u03c0\u03c4_p)\u2211_j=1^k-1F_\u03bd,jF_\u03c1,j+1\u03c4_p/\u03c0,\n    \n    \n    QP_k,k+1,dis,isi   =1/6(F_\u03bc,kF_\u03bd,kF_\u03c1,k+1- F_\u03bc,kF_\u03bd,k-1F_\u03c1,k)(2\u03c4_p/\u03c0)^2,\n    \n    \n    Q_self   =0.\n\n\n\n\n \u00a7.\u00a7 Ising-Ising Rules\n\nWe will now compute the first-order Ising-Ising term. Using the definitions of the individual terms as in the previous calculation (taking both \u03b1 and \u03b2 to be Ising indices), we find\n\n    A_free   =\u2211_k=1^n|F_\u03bc,k|(\u03c4_k+\u03c4_p)\u2211_l=1^k-1|F_\u03bd,l|(\u03c4_l+\u03c4_p)\n       =\u2211_k=1^n|F_\u03bc,k|(\u03c4_k+\u03c4_p)I_<a^\u03bd,\n    \n    P_k,k+1,isi,isi   =(|F_\u03bc,k||F_\u03bd,k+1|-|F_\u03bc,k+1||F_\u03bd,k|)(\u03c0^2/32-1/4)(2\u03c4_p/\u03c0)^2\n\nSimilar to the disorder-disorder case and the disorder-Ising case, we have no contribution from the C^(1)_\u03b1,\u03b2,k terms. Next, we calculate the contribution from the q-terms. Directly plugging things in\n\n    QA_free   =\u2211_k=1^n|F_\u03bc,k|(\u03c4_k+\u03c4_p)\u2211_j=1^k-1F_\u03bd,kF_\u03c1,k+1\u03c4_p/\u03c0+\u2211_k=1^nF_\u03bc,kF_\u03c1,k+1\u03c4_p/\u03c0\u2211_l=1^k|F_\u03bd,l|(\u03c4_l+\u03c4_p),\n    \n    QP_k,k+1,isi,isi   =\u03c4_p^2/8\u03c0(F_\u03bc,kF_\u03bb,k+1|F_\u03bd,k+1|-F_\u03bc,kF_\u03bb,k+1|F_\u03bd,k|+|F_\u03bc,k|F_\u03bd,kF_\u03c1,k+1-|F_\u03bc,k|F_\u03bd,k-1F_\u03c1,k),\n    \n    Q_self   =\u2211_k=1^nF_\u03bc,kF_\u03bb,k+1\u03c4_p/\u03c0\u2211_l=1^k-1F_\u03bd,lF_\u03c1,l+1\u03c4_p/\u03c0+\u2211_k=1^n\u03c4_p^2/2\u03c0^2F_\u03bc,kF_\u03bb,k+1F_\u03bd,kF_\u03c1,k+1.\n\n\n\n\n \u00a7.\u00a7 Ising-Heisenberg Rules\n\nFinally, we calculate the first-order Ising-Heisenberg terms.\n\nTaking \u03b1 to be the Ising terms, we can repeat the derivation from disorder-Heisenberg rules to find that the main terms can be written as\n\n    \u2211_k=1^n|F_\u03bc,k|(\u03c4_k+\u03c4_p)(t_k-T/2),\n\nwhich simply replaces the F_\u03bc,k in the original disorder-Heisenberg rule by |F_\u03bc,k|.\n\nAlthough this term is no longer cancelled by imposing a zero net dipole, we can still formulate a simple condition for it to be cancelled: if we have \u201cbalanced\" rows, in which the center of mass of each row is in the middle, then this term will be cancelled.\n\nFor example, a simple mirror symmetrization will cancel this first-order term.\n\nFor the q-terms, using the expressions found above, we can easily calculate\n\n    QA_free   =\u2211_k=1^nF_\u03bc,kF_\u03bb,k+1\u03c4_p/\u03c0\u2211_l=1^k(\u03c4_l+\u03c4_p),\n    \n    QP_k,k+1,isi,heis   =\u03c0/8(2\u03c4_p/\u03c0)^2F_\u03bc,kF_\u03bb,k+1,\n    \n    \n    Q_free   =0.\n\nWe note that after summing the pulse term over k, we can add the two expressions together to obtain\n\n    Q_tot=\u2211_k=1^nF_\u03bc,kF_\u03bb,k+1\u03c4_p/\u03c0(\u2211_l=1^k(\u03c4_l+\u03c4_p)+\u03c4_p/2).\n\nWe note that the second sum is exactly the time at the middle of the pulse, similarly to the other Heisenberg rules. This tells us that we can cancel this the same way, by balancing the center of mass for terms of the form F_\u03bc,kF_\u03bb,k+1.\n\n\n\n \u00a7.\u00a7 Summary of Two Qubit Commutators\n\nWe lastly summarize the general commutators of the form \ud835\udcaa_\u03b1, \ud835\udcaa_\u03b2 over a basis of two-qubit operators, { O_\u03b1}_\u03b1, to be defined shortly. To this end, it is convienent to write a generic two-qubit Hamiltonian in the form of a 4 \u00d7 4 matrix \ud835\udc9c, \n\n    H(\ud835\udc9c)    = \u2211_\u03bc\u03bd=0^3 \ud835\udc9c_\u03bc\u03bd \u03c3_\u03bc\u2297\u03c3_\u03bd,\n\nwhere we have defined \u03c3_\u03bc = ( 1, \u03c3\u20d7) as a 4-vector of Pauli operators, including the 2 \u00d7 2 identity matrix 1. It follows that a native symmetric secular Hamiltonian can be specified by the matrix\n\n    \ud835\udc9c   = ([       0       0       0     h_2;       0     g_0       0       0;       0       0     g_0       0;     h_1       0       0 g_0+g_1;         ]),\n\nparameterized by disorder fields h_1,h_2 and Heisenberg/Ising interactions g_0, g_1. Note that we have introduced horizontal and vertical bars to visually distinguish between interactions and disorder. As explained in the main-text, under global driving mapping S_z \u2192 F_\u03bc S_\u03bc the secular Hamiltonian will depend only on this column vector F. This representation of the 2-qubit interaction will thus transform as \n\n    \ud835\udc9c\u21a6\ud835\udc9c'( F)   =([                                               h_2 F^T                  ;                                                                        ;             h_1 F                   g_0 1 + g_1  FF^T                  ;                                                                        ;                   ]), \n       = \u2211_\u03b1 c_\u03b1 \ud835\udc9c_\u03b1(F),\n\nwhere {\ud835\udc9c_\u03b1(F) }_\u03b1 are judicious choice of operator basis. A particular choice of operators that is convenient to summarize the commutators is the following \n\n    {\ud835\udc9c_\u03b1(F) }_\u03b1   = {\ud835\udc9c_\u00b1(F) = ([           \u00b1F^T     ;                    ;    F         0     ;                    ;      ]), \ud835\udc9c_H =([        ;        ;     1  ;        ;   ]),  \ud835\udc9c_I(F) = ([                    ;                    ;           FF^T     ;                    ;      ]) }.\n\nThe matrix commutator between the interaction picture Hamiltonians in different frames lifts to a bracket on the basis \ud835\udc9e matrices, yielding surprisingly simple \u201cselection rules\" for understanding the structure behind the first order Magnus calculation. \n\nBefore presenting the result, we define two more interactions\n        \n        \n    \ud835\udc9c\u0303_I( F,  G)    =  ([                                                                    ;                                                                    ;                                   (FG^T + GF^T )/2                 ;                                                                    ;                  ]), \n    \ud835\udc9c_A( F)    =  ([                                        ;                                        ;                     \u03f5_ijk F_k          ;                                        ;           ]),\n\n\nwhere the first one contains the Ising interaction \ud835\udc9c_I( F) = \ud835\udc9c\u0303_I( F, F) as a special case, and the second one is an anti-symmetric exchange  \ud835\udc9c_A( F).\n\nDisorder, Disorder \u2192 Disorder\n\n\n\t\n  * \ud835\udc9c_\u03c3(\ud835\udc05),\ud835\udc9c_\u03c3'(\ud835\udc06) = 2i  \ud835\udc9c_\u03c3\u03c3'(\ud835\udc05\u00d7\ud835\udc06)     \u03c3, \u03c3' \u2208\u00b1 \n\n\nDisorder, Interaction \u2192 Interaction\n\n\n\t\n  * \ud835\udc9c_+(\ud835\udc05), \ud835\udc9c_H  =0\n\t\n  * \ud835\udc9c_+(\ud835\udc05), \ud835\udc9c_I(\ud835\udc06)  = 4i  \ud835\udc9c\u0303_I(\ud835\udc06, \ud835\udc05\u00d7\ud835\udc06)\n\t\n  * \ud835\udc9c_-(\ud835\udc05), \ud835\udc9c_H  = -4 i  \ud835\udc9c_A(\ud835\udc05)\n\t\n  * \ud835\udc9c_-(\ud835\udc05), \ud835\udc9c_I(\ud835\udc06)  = 2i((F\u00b7 G) \ud835\udc9c_A(\ud835\udc06)-\ud835\udc9c_A(\ud835\udc05))\n\n\nInteraction, Interaction \u2192 Disorder\n\n\n\t\n  * \ud835\udc9c_H, \ud835\udc9c_H  = 0\n\t\n  * \ud835\udc9c_H, \ud835\udc9c_I(\ud835\udc06)  = 0\n\t\n  * \ud835\udc9c_I(\ud835\udc05), \ud835\udc9c_I(\ud835\udc06)  = 2i   (F \u00b7 G) \ud835\udc9c_+(\ud835\udc05\u00d7\ud835\udc06)=0 for pulse sequences built from \u03c0/2,\u03c0 pulses\n\n\n\n\n\n\n\u00a7 DERIVATION OF SECOND-ORDER DECOUPLING RULES\n\n\nFrom Eq.\u00a0(<ref>), we have that the cancellation condition for the second-order term is given by two integrals\n\n    \u222d_0<t_3<t_2<t_1<Tc_\u03b1(t_1)c_\u03b2(t_2)c_\u03b3(t_3)+\u222d_0<t_1<t_2<t_3<Tc_\u03b1(t_1)c_\u03b2(t_2)c_\u03b3(t_3).\n\n\nIn order to see the similarities to the previous order, we write the above integrals as follows\n\n    \u222b_0^Tdt_1c_\u03b1(t_1)(\u222c_0<t_3<t_2<t_1c_\u03b2(t_2)c_\u03b3(t_3)+\u222c_t_1<t_2<t_3<Tc_\u03b2(t_2)c_\u03b3(t_3)).\n\nNoting that the coefficient here is [^\u03b1,[^\u03b2,^\u03b3]], we can again sum the terms which have \u03b2 and \u03b3 switched, as we did with first order, and derive the following expression\n\n    H^(2)   =1/6T ([^\u03b1,[^\u03b2,^\u03b3]])\u222b_0^Tdt_1c_\u03b1(t_1)\u00b7\n       \u00b7( \u222c_0<t_3<t_2<t_1 c_\u03b2(t_2)c_\u03b3(t_3)-\u222c_0<t_2<t_3<t_1 c_\u03b2(t_2)c_\u03b3(t_3).+\n       +.\u222c_t_1<t_2<t_3<Tc_\u03b2(t_2)c_\u03b3(t_3)-\u222c_t_1<t_3<t_2<Tc_\u03b2(t_2)c_\u03b3(t_3)).\n\nThe inner integrals in the above expression are the first order contribution of the \u03b2,\u03b3 first order term for all times before t_1, minus the first order contribution of the \u03b2,\u03b3 first order term for all times after t_1. Letting \n\n    c^(1)_\u03b2, \u03b3(t_1,t_2)   = \u222c\n    t_1<t_a<t_b<t_2c_\u03b2(t_a)c_\u03b3(t_b)-\u222c\n    t_1<t_b<t_a<t_2c_\u03b2(t_a)c_\u03b3(t_b),\n\nwhich is exactly the first order contribution between times t_1 and t_2 of the operator [^\u03b2,^\u03b3], we can rewrite the expression as follows\n\n\n    H^(2)   =1/6T ([^\u03b1,[^\u03b2,^\u03b3]])\u222b_0^Tdt_1c_\u03b1(t_1)(c^(1)_\u03b2,\u03b3(0,t_1)-c^(1)_\u03b2,\u03b3(t_1,T) ).\n\nWe then write\n\n    \u222b_0^Tdt_1c_\u03b1(t_1) (c^(1)_\u03b2,\u03b3(0,t_1)-c^(1)_\u03b2,\u03b3(t_1,T) )\n    \n        =   \u222b_0^Tdt_1c_\u03b1(t_1)c^(1)_\u03b2,\u03b3(0,t_1)-\u222b_0^Tdt_1c_\u03b1(t_1)(c^(1)_\u03b2,\u03b3(0,T)-c^(1)_\u03b2,\u03b3(0,t_1))\n    =    2\u222b_0^Tdt_1c_\u03b1(t_1)c^(1)_\u03b2,\u03b3(0,t_1)-c^(1)_\u03b2,\u03b3(0,T)\u222b_0^Tdt_1c_\u03b1(t_1).\n\n\nWe note that this form is identical to the first order case, with c_\u03b2(t) replaced by c^(1)_\u03b2,\u03b3(0,t). We will now perform the same substitution that we did for first order to convert the integral expression into a summation expression. For simplicity, we restrict our discussion to Hamiltonians involving disorder only. In this case, c^(1)_\u03b2,\u03b3 does not change over a free evolution period, i.e. looking at c^(1)_\u03b2,\u03b3(0,t_a) and c^(1)_\u03b2,\u03b3(0,t_b), for t_a,t_b in the same free evolution period, the contribution to the overall term is 0, as the commutator [^\u03b2,^\u03b3] will be 0 during this time. Thus we can write the same approximation for this term as in the 1st order term\n\n    A   =\u222b_0^Tdt_1c_\u03b1(t_1)c^(1)_\u03b2,\u03b3(0,t_1)\n       =A_free+\u2211_k=1^n-1P_k,k+1,\u03b1,\u03b2,\u03b3+\u2211_k=1^nC^(2)_\u03b1,\u03b2,\u03b3,k,\n\nwhere\n\n    C^(2)_\u03b1,\u03b2,\u03b3,k   =\u222b_t_k-1+\u03c4_k-1/2^t_k+1-\u03c4_k+1/2c_\u03b1(t_1)dt_1\u222b_t_k-1+\u03c4_k-1/2^t_1c^(1)_\u03b2,\u03b3(0,t_2)dt_2,\n    \n        P_k,k+1,\u03b1,\u03b2,\u03b3   =\u222b_0^\u03c0/2_\u03b1,k(\u03b8_1)rd\u03b8_1\u222b_0^\u03b8_1^(1)_\u03b2,\u03b3,k+1(\u03b8_2)rd\u03b8_2-\u222b_0^\u03c0/2_\u03b1,k+1(\u03b8_1)rd\u03b8_1\u222b_\u03b8_1^\u03c0/2^(1)_\u03b2,\u03b3,k(\u03b8_2)rd\u03b8_2,\n    \n        A_free   =\u2211_k=1^nC_\u03b1,k\u2211_j=1^k-1C_\u03b2,\u03b3,j.\n\nHere C_\u03b2,\u03b3,j=C_\u03b2,j\u2211_\u2113=1^j-1C_\u03b3,\u2113, and the angle terms are defined as follows:\n\n    ^(1)_\u03b2,\u03b3,k(\u03b8)   =   \u222c_0\u2264\u03b8_1\u2264\u03b8_2\u2264\u03b8_\u03b2(\u03b8_1)_\u03b3(\u03b8_2)-\u222c_0\u2264\u03b8_2\u2264\u03b8_1\u2264\u03b8_\u03b2(\u03b8_1)_\u03b3(\u03b8_2),\n    ^(1)_\u03b2,\u03b3,k(\u03b8)   =    \u222c_0\u2264\u03b8_1\u2264\u03b8_2\u2264\u03b8_\u03b2(\u03b8_1)_\u03b3(\u03b8_2)-\u222c_0\u2264\u03b8_2\u2264\u03b8_1\u2264\u03b8_\u03b2(\u03b8_1)_\u03b3(\u03b8_2).\n\nWe note that this means if the two ramp up functions are proportional, i.e. _\u03b3(\u03b8)=F_\u03b3,ksin(\u03b8), _\u03b2(\u03b8)=F_\u03b2,ksin(\u03b8), these terms will always be 0. There are also no q-terms as we are restricting to a disorder Hamiltonian. Thus, the only term left is the free evolution term with the frame-lengthening correction.\n\nWe can now plug in expressions for the explicit terms in the qubit Hamiltonian to calculate the leading second-order effects. The free evolution period is much like the lower orders\n\n    A_free=\u2211_k=1^nF_\u03bc,k(\u03c4_k+4/\u03c0\u03c4_p)F^\u03bd,\u03c1_<k,\n\nwhere F^\u03bd,\u03c1_<k=\u2211_l=1^kF_\u03bd,l(\u03c4_l+4/\u03c0\u03c4_p)(F^\u03c1_<l-F^\u03c1_>l) is the first-order contribution given by \u03bd,\u03c1 through time k. By combining A_free with the rest of the terms, we obtain the expression in Tab.\u00a0<ref>\n\n    2\u2211_k=1^n F_\u03bc,k(\u03c4_k+4/\u03c0\u03c4_p)F_<k^\u03bd,\u03c1 - F^\u03bcF^\u03bd,\u03c1,\n\nwhere F^\u03bd,\u03c1=\u2211_k=1^nF_\u03bd,k(\u03c4_k+4/\u03c0\u03c4_p)F_<k^\u03c1 is the total first-order disorder-disorder term between axes \u03bd and \u03c1.\n"}